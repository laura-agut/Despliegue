
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://laura-agut.github.io/Despliegue/Ud6%20Servidores%20de%20aplicaciones/P06-Cluster/">
      
      
        <link rel="prev" href="../P05-DockerizacionNodeJs/">
      
      
        <link rel="next" href="../P07-Netlify/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.19">
    
    
      
        <title>Pr√°ctica 6 - Despliegue de una aplicaci√≥n "clusterizada" con Node Express - Despliegue de aplicaciones web</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#practica-6-despliegue-de-una-aplicacion-clusterizada-con-node-express" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="../.." title="Despliegue de aplicaciones web" class="md-header__button md-logo" aria-label="Despliegue de aplicaciones web" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Despliegue de aplicaciones web
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Pr√°ctica 6 - Despliegue de una aplicaci√≥n "clusterizada" con Node Express
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="indigo"  aria-label="Cambiar a modo oscuro"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Cambiar a modo oscuro" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Cambiar a modo claro"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Cambiar a modo claro" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="B√∫squeda" placeholder="B√∫squeda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Buscar">
        
        <button type="reset" class="md-search__icon md-icon" title="Limpiar" aria-label="Limpiar" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Inicializando b√∫squeda
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navegaci√≥n" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Despliegue de aplicaciones web" class="md-nav__button md-logo" aria-label="Despliegue de aplicaciones web" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Despliegue de aplicaciones web
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Despliegue de aplicaciones web
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ud0 Introduccion
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Ud0 Introduccion
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/Ud0_1Introalmodulo/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.1. Introducci√≥n al m√≥dulo
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/Ud0_2AWS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    0.2. Introducci√≥n a AWS Academy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/ejercicio-final-ebs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    üß™ Ejercicio final: modifica, prueba en local y despliega en Elastic Beanstalk
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Pr√°cticas
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Pr√°cticas
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/P0_1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P0.1. Linux Server en AWSAcademy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/P0_2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P0.2 Windows Server en AWSAcademy
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/P0_3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P0.3. Conceder acceso a un segundo administrador
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/P0_4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P0.4. Comandos b√°sicos Linux
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Ud0%20Introduccion/P0_5/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P0.5: Despliegue Java en AWS Elastic Beanstalk
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="practica-6-despliegue-de-una-aplicacion-clusterizada-con-node-express">Pr√°ctica 6: Despliegue de una aplicaci√≥n "clusterizada" con Node Express</h1>
<h2 id="introduccion">Introducci√≥n</h2>
<p>Cuando se construye una aplicaci√≥n de producci√≥n, normalmente se busca la forma de optimizar su rendimiento llegando a una soluci√≥n de compromiso. En esta pr√°ctica echaremos un vistazo a un enfoque que puede ofrecer una victoria r√°pida cuando se trata de mejorar la manera en que las aplicaciones Node.js manejan la carga de trabajo.</p>
<p>Una instancia de Node.js se ejecuta en un solo hilo, lo que significa que en un sistema multin√∫cleo (como la mayor√≠a de los ordenadores de hoy en d√≠a), no todos los n√∫cleos ser√°n utilizados por la aplicaci√≥n. Para aprovechar los otros n√∫cleos disponibles, podemos lanzar un cluster de procesos Node.js y distribuir la carga entre ellos.</p>
<p><img alt="" src="../P3_5/imagen_cluster.png" /></p>
<p>Tener varios hilos para manejar las peticiones mejora el rendimiento (peticiones/segundo) del servidor, ya que varios clientes pueden ser atendidos simult√°neamente. Veremos c√≥mo crear procesos hijos con el m√≥dulo de cluster de Node.js para, m√°s tarde, ver c√≥mo gestionar el cluster con el gestor de procesos PM2.</p>
<h3 id="un-vistazo-rapido-a-los-clusters">Un vistazo r√°pido a los clusters</h3>
<p><a href="https://nodejs.org/api/cluster.html">El m√≥dulo de cl√∫ster de Node.js</a> permite la creaci√≥n de procesos secundarios (<em>workers</em>) que se ejecutan simult√°neamente y comparten el mismo puerto de servidor. Cada hijo generado tiene su propio ciclo de eventos y memoria. Los procesos secundarios utilizan IPC (comunicaci√≥n entre procesos) para comunicarse con el proceso principal de Node.js.</p>
<p>Tener m√∫ltiples procesos para manejar las solicitudes entrantes significa que se pueden procesar varias solicitudes simult√°neamente y si hay una operaci√≥n de bloqueo/ejecuci√≥n prolongada en un <em>worker</em>, los otros <em>workers</em> pueden continuar administrando otras solicitudes entrantes; la aplicaci√≥n no se detendr√° hasta que finalice la operaci√≥n de bloqueo.</p>
<p>La ejecuci√≥n de varios <em>workers</em> tambi√©n permite actualizar la aplicaci√≥n en producci√≥n con poco o ning√∫n tiempo de inactividad. Se pueden realizar cambios en la aplicaci√≥n y reiniciar los <em>workers</em> uno por uno, esperando que un proceso secundario se genere por completo antes de reiniciar otro. De esta manera, siempre habr√° <em>workers</em> ejecut√°ndose mientras se produce la actualizaci√≥n.</p>
<p>Las conexiones entrantes se distribuyen entre los procesos secundarios de dos maneras:</p>
<ul>
<li>
<p>El proceso maestro escucha las conexiones en un puerto y las distribuye entre los <em>workers</em> de forma rotatoria. Este es el enfoque por defecto en todas las plataformas, excepto Windows.</p>
</li>
<li>
<p>El proceso maestro crea un socket de escucha y lo env√≠a a los <em>workers</em> interesados ‚Äã‚Äãque luego podr√°n aceptar conexiones entrantes directamente.</p>
</li>
</ul>
<h3 id="usando-los-clusters">Usando los clusters</h3>
<p>Como hemos visto necesitamos que nuestro equipo tenga varias CPU para hacer que cada proceso corra en una CPU distinta.
Por tanto, crearemos un servidor DEBIAN en AWS, pero en este caso no aceptaremos los valores por defecto, sino que crearemos una instancia con 2 vCPU's.</p>
<ul>
<li>Crea una nueva EC2 Debian y ll√°male "DebianNodejsCluster"</li>
<li>El tipo de instancia selecci√≥na t2.medium. F√≠jate que tiene 2 vCPU</li>
<li>Recuerda crear un grupo de seguridad adecuado como en la pr√°ctica anterior. Dale el mismo nombre que a la EC2. Tambi√©n puedes usar el de la pr√°ctica anterior.</li>
<li>Instala Node.js y Express como hicimos en la pr√°ctica anterior</li>
</ul>
<h4 id="primero-sin-cluster">Primero sin cl√∫ster</h4>
<p>Para ver las ventajas que ofrece la agrupaci√≥n en cl√∫steres, comenzaremos con una aplicaci√≥n de prueba en Node.js que no usa cl√∫steres y la compararemos con una que s√≠ los usa, se trata de la siguiente:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">);</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="p">});</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/:n&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">n</span><span class="p">);</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5000000000</span><span class="p">)</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000000000</span><span class="p">;</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">n</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="sb">`Final count is </span><span class="si">${</span><span class="nx">count</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="p">});</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`App listening on port </span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a><span class="p">});</span>
</code></pre></div>
Se trata de una aplicaci√≥n un tanto <em>prefabricada</em> en el sentido de que es algo que jam√°s encontrar√≠amos en el mundo real. No obstante, nos servir√° para ilustrar nuestro prop√≥sito.</p>
<p>Esta aplicaci√≥n contiene dos rutas, una ruta ra√≠z <code>/</code> que devuelve la cadena <code>Hello World!</code> y otra ruta <code>/api/n</code> donde se toma <code>n</code> como par√°metro y va realizando una operaci√≥n de suma (el bucle for) cuyo resultado acumula en la variable <code>count</code> que se muestra al final.</p>
<p>Si a este par√°metro <code>n</code>, le damos un valor muy alto, nos permitir√° simular operaciones intensivas y de ejecuci√≥n prolongada en el servidor. Le damos como valor l√≠mite <code>5000000000</code> para evitar una operaci√≥n demasiado costosa para nuestro ordenador.</p>
<div class="admonition task">
<p class="admonition-title">Task</p>
<ol>
<li>Deb√©is conectaros al servidor Debian mediante SSH</li>
<li>Deb√©is crear un directorio para el proyecto de esta aplicaci√≥n. Ll√°male <code>pruebacluster</code>.</li>
<li>DENTRO del directorio ejecutar√©is 2 comandos:<ol>
<li><code>npm init</code> para crear autom√°ticamente la estructura de carpetas y el archivo <code>package.json</code> (Con ir d√°ndole a &lt;ENTER&gt; a todas las preguntas, os basta)</li>
<li><code>npm install express</code> para instalar express para este proyecto</li>
</ol>
</li>
<li>Crea el archivo del programa, que podemos llamar <code>pruebacluster.js</code>. Pega dentro el contenido de la aplicaci√≥n que vimos anteriormente.</li>
<li>Tras esto, DENTRO del directorio, ya pod√©is iniciar la aplicaci√≥n con: <code>node pruebacluster.js</code></li>
</ol>
</div>
<p>Para comprobarlo, pod√©is acceder a <code>http://IP-maq-virtual:3000</code> o a <code>http://IP-maq-virtual:3000/api/50</code> donde <code>IP-maq-virtual</code> es la IP de vuestro servidor Debian en AWS.</p>
<p>Vamos ver el tiempo que tardan en procesarse los programas en funci√≥n del <code>n</code>. Usaremos Mozilla Firefox, aunque otros navegadores tienen herramientas similares. Antes de lanzar la aplicaci√≥n abre las devoloper tools en Firefox. Ve al "men√∫ hamburguesa" (las tres rayitas horizontales arriba a la derecha) - M√°s herramientas - Herramientas para desarrolladores. En la parte inferior del navegador se abrir√°n las herramientas y selecciona "Red". Ya podemos lanzar la aplicaci√≥n.</p>
<p>Utilizada un valor de <code>n</code> relativamente peque√±o, como el 50 del ejemplo anterior y comprobar√©is que se ejecutar√° r√°pidamente, devolviendo una respuesta casi inmediata, del orden de milisegundos. Recuerda o anota el valor.</p>
<p>Hagamos otra simple comprobaci√≥n para valores de <code>n</code> m√°s grandes. Desplegada e iniciada la aplicaci√≥n, acceded a la ruta <code>http://IP-maq-virtual:3000/api/5000000000</code>. Comprobad que ahora tarda varios segundos. Recuerda o anota el valor.</p>
<p><img alt="" src="../P3_5/no-cluster-1.png" /></p>
<p>Ahora ya sabemos lo que le cuesta a nuestro servidor ejecutar el programa para un valor de 50 y uno de 5000000000 cuando solo est√° ejecutando un proceso. Veamos qu√© pasa si tiene que ejecutar 2 a la vez. Prepara 2 pesta√±as en tu navegador, con las herramientas para desarrolladores activadas y en una de ellas la URL <code>http://IP-maq-virtual:3000/api/5000000000</code> y en la otra <code>http://IP-maq-virtual:3000/api/50</code>.</p>
<p>Ya est√° el entorno de pruebas listo. Ahora ejecuta el programa con el 5000000000. Mientras esta solicitud que tarda unos segundos se est√° procesando, acceded a la otra pesta√±a del navegador con <code>http://IP-maq-virtual:3000/api/50</code> y ejecutalo.</p>
<p><img alt="" src="../P3_5/no-cluster-2.png" /></p>
<p>Utilizando las devoloper tools, podemos ver el tiempo que tardan en procesarse las solicitudes:</p>
<ol>
<li>La primera solicitud, al tener un valor de <code>n</code> grande, nos lleva unos cuantos segundos completarla. M√°s o menos como antes</li>
<li>La segunda solicitud, pese a tener un valor de <code>50</code> que ya hab√≠amos comprobado que ofrec√≠a una respuesta de milisegundos, tambi√©n se demora unos segundos.</li>
</ol>
<p><strong>¬øPor qu√© ocurre esto?</strong> Porque el √∫nico subproceso estar√° ocupado procesando la otra operaci√≥n de ejecuci√≥n prolongada. El √∫nico n√∫cleo de la CPU tiene que completar la primera solicitud antes de que pueda encargarse de la otra. As√≠ que la segunda tarda lo que le queda de proceso a la primera, que est√° esperando m√°s su tiempo de ejecuci√≥n.</p>
<h4 id="ahora-con-mas-cluster">¬°Ahora con m√°s cl√∫ster!</h4>
<p>Ahora usaremos el m√≥dulo de cl√∫ster en la aplicaci√≥n para generar algunos procesos secundarios y ver c√≥mo eso mejora las cosas.</p>
<p>A continuaci√≥n se muestra la aplicaci√≥n modificada:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">3000</span><span class="p">;</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kd">const</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;cluster&quot;</span><span class="p">);</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="kd">const</span><span class="w"> </span><span class="nx">totalCPUs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;os&quot;</span><span class="p">).</span><span class="nx">cpus</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cluster</span><span class="p">.</span><span class="nx">isMaster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Number of CPUs is </span><span class="si">${</span><span class="nx">totalCPUs</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Master </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="si">}</span><span class="sb"> is running`</span><span class="p">);</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w"> </span><span class="c1">// Fork workers.</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">totalCPUs</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">fork</span><span class="p">();</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;exit&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">worker</span><span class="p">,</span><span class="w"> </span><span class="nx">code</span><span class="p">,</span><span class="w"> </span><span class="nx">signal</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`worker </span><span class="si">${</span><span class="nx">worker</span><span class="p">.</span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="si">}</span><span class="sb"> died`</span><span class="p">);</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Let&#39;s fork another worker!&quot;</span><span class="p">);</span>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w"> </span><span class="nx">cluster</span><span class="p">.</span><span class="nx">fork</span><span class="p">();</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a><span class="w"> </span><span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Worker </span><span class="si">${</span><span class="nx">process</span><span class="p">.</span><span class="nx">pid</span><span class="si">}</span><span class="sb"> started`</span><span class="p">);</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">);</span>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/api/:n&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">n</span><span class="p">);</span>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">5000000000</span><span class="p">)</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5000000000</span><span class="p">;</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">n</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="w"> </span><span class="nx">count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">i</span><span class="p">;</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="sb">`Final count is </span><span class="si">${</span><span class="nx">count</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="w"> </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`App listening on port </span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="w"> </span><span class="p">});</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="p">}</span>
</code></pre></div>
Esta aplicaci√≥n hace lo mismo que antes pero esta vez estamos generando varios procesos secundarios que compartir√°n el puerto 3000 y que podr√°n manejar las solicitudes enviadas a este puerto. Los procesos de trabajo se generan utilizando el m√©todo <code>child_process.fork()</code>. El m√©todo devuelve un objeto <code>ChildProcess</code> que tiene un canal de comunicaci√≥n incorporado que permite que los mensajes se transmitan entre el hijo y su padre.</p>
<p>Creamos tantos procesos secundarios como n√∫cleos de CPU hay en la m√°quina en la que se ejecuta la aplicaci√≥n. Se recomienda no crear m√°s <em>workers</em> que n√∫cleos l√≥gicos en la computadora, ya que esto puede causar una sobrecarga en t√©rminos de costos de programaci√≥n. Esto sucede porque el sistema tendr√° que programar todos los procesos creados para que se vayan ejecutando por turnos en los n√∫cleos.</p>
<p>Los <em>workers</em> son creados y administrados por el proceso maestro. Cuando la aplicaci√≥n se ejecuta por primera vez, verificamos si es un proceso maestro con <code>isMaster</code>. Esto est√° determinado por la variable <code>process.env.NODE_UNIQUE_ID</code>. Si <code>process.env.NODE_UNIQUE_ID</code> tiene valor <em>undefined</em>, entonces <code>isMaster</code> ser√° <em>true</em>.</p>
<p>Si el proceso es un maestro, llamamos a <code>cluster.fork()</code> para generar varios procesos. Registramos los ID de proceso maestro y <em>worker</em>. Cuando un proceso secundario muere, generamos uno nuevo para seguir utilizando los n√∫cleos de CPU disponibles.</p>
<p>Ahora repetiremos el mismo experimento de antes, primero realizamos una solicitud al servidor con un valor alto <code>n</code>: </p>
<p><img alt="" src="../P3_5/clusterOK-1.png" /></p>
<p>Y ejecutamos r√°pidamente otra solicitud en otra pesta√±a del navegador, midiendo los tiempos de procesamiento de ambas:</p>
<p><img alt="" src="../P3_5/clusterOK-2.png" /></p>
<p>Comprobaremos que √©stos se asemejan mucho m√°s a los que obtuvimos ejecutando la aplicaci√≥n de forma independiente.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Con varios <em>workers</em> disponibles para aceptar solicitudes, se mejoran tanto la disponibilidad del servidor como el rendimiento.</p>
</div>
<p>Ejecutar una solicitud en una pesta√±a del navegador y ejecutar r√°pidamente otra en una segunda pesta√±a sirve para mostrarnos la mejora que ofrece la agrupaci√≥n en cl√∫steres para nuestro ejemplo de una forma m√°s o menos r√°pida, pero es un m√©todo un tanto "chapucero" y no es una forma adecuada o confiable de determinar las mejoras de rendimiento.</p>
<p>En el siguiente apartado echaremos un vistazo a algunos puntos de referencia que demostrar√°n mejor cu√°nto ha mejorado la agrupaci√≥n en cl√∫steres nuestra aplicaci√≥n.</p>
<h4 id="metricas-de-rendimiento">M√©tricas de rendimiento</h4>
<p>Realizaremos una prueba de carga en nuestras dos aplicaciones para ver c√≥mo cada una maneja una gran cantidad de conexiones entrantes. Usaremos el paquete <code>loadtest</code> para esto.</p>
<p>El paquete <code>loadtest</code> nos permite simular una gran cantidad de conexiones simult√°neas a nuestra API para que podamos medir su rendimiento.</p>
<p>Para usar <code>loadtest</code>, primero debemos instalarlo globalmente. Tras conectaros por SSH al servidor Debian:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>sudo<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>-g<span class="w"> </span>loadtest
</code></pre></div>
<p>Luego ejecutamos la aplicaci√≥n que queremos probar (<code>node nombre_aplicacion.js</code>). Comenzaremos probando la versi√≥n que no utiliza la agrupaci√≥n en cl√∫steres.</p>
<p>Mientras ejecutamos la aplicaci√≥n, en otro terminal realizamos la siguiente prueba de carga:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>loadtest<span class="w"> </span>http://localhost:3000/api/500000<span class="w"> </span>-n<span class="w"> </span><span class="m">1000</span><span class="w"> </span>-c<span class="w"> </span><span class="m">100</span>
</code></pre></div>
<p>El comando anterior enviar√° 1000 solicitudes a la URL dada, de las cuales 100 son concurrentes. El siguiente es el resultado de ejecutar el comando anterior:</p>
<p><img alt="" src="../P3_5/loadtest_no_cluster.png" /></p>
<p>Vemos que con la misma solicitud (con n= 500000) el servidor ha podido manejar 404 solicitudes por segundo con una latencia media de 232.4 milisegundos (el tiempo promedio que tarda en completar una sola solicitud). Anota los datos que obtienes en tu caso.</p>
<p>Intent√©moslo de nuevo, pero esta vez con un n mayor n=5000000 (y sin cl√∫steres):</p>
<p><img alt="" src="../P3_5/loadtest_no_cluster_2.png" /></p>
<p>Vemos que las m√©tricas arrojan resultados peores. Anota los datos que obtienes en tu caso.</p>
<p>Ahora detenemos nuestra aplicaci√≥n sin cl√∫sters y ejecutamos la que s√≠ los tiene (<code>node nombre_aplicacion_cluster.js</code>). Ejecutaremos exactamente las mismas pruebas con el objetivo de realizar una comparaci√≥n:</p>
<p><img alt="" src="../P3_5/loadtest_cluster.png" /></p>
<p><img alt="" src="../P3_5/loadtest_cluster_2.png" /></p>
<p>Anota los datos que obtienes en tu caso y comp√°ralos con los obtenidos en la aplicaci√≥n sin clusters. Es obvio que los cl√∫sters permiten manejar una mayor cantidad de peticiones por segundo con una menor latencia.</p>
<h4 id="uso-de-pm2-para-administrar-un-cluster-de-nodejs">Uso de PM2 para administrar un cl√∫ster de Node.js</h4>
<p>En nuestra aplicaci√≥n, hemos usado el m√≥dulo <code>cluster</code> de Node.js para crear y administrar manualmente los procesos.</p>
<p>Primero hemos determinado la cantidad de <em>workers</em> (usando la cantidad de n√∫cleos de CPU como referencia), luego los hemos generado y, finalmente, escuchamos si hay <em>workers</em> muertos para poder generar nuevos.</p>
<p>En nuestra aplicaci√≥n de ejemplo muy sencilla, tuvimos que escribir una cantidad considerable de c√≥digo solo para administrar la agrupaci√≥n en cl√∫steres. En una aplicaci√≥n de producci√≥n es bastante probable que se deba escribir a√∫n m√°s c√≥digo.</p>
<p>Existe una herramienta que nos puede ayudar a administrar todo esto un poco mejor: el administrador de procesos <code>PM2</code>. <code>PM2</code> es un administrador de procesos de producci√≥n para aplicaciones Node.js con un balanceador de carga incorporado.</p>
<p>Cuando est√° configurado correctamente, <code>PM2</code> ejecuta autom√°ticamente la aplicaci√≥n en modo de cl√∫ster, generando <em>workers</em> y se encarga de generar nuevos <em>workers</em> cuando uno de ellos muera.</p>
<p><code>PM2</code> facilita la parada, eliminaci√≥n e inicio de procesos, adem√°s de disponer de algunas herramientas de monitorizaci√≥n que pueden ayudarnos a monitorizar y ajustar el rendimiento de su aplicaci√≥n.</p>
<p>Para usar <code>PM2</code>, primero instalamos globalmente en nuestra Debian:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>sudo<span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>pm2<span class="w"> </span>-g
</code></pre></div>
<p>Vamos a utilizarlo con nuestra primera aplicaci√≥n, la que no estab "clusterizada" en el c√≥digo. Para ello ejecutaremos el siguiente comando:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>pm2<span class="w"> </span>start<span class="w"> </span>nombre_aplicacion_sin_cluster.js<span class="w"> </span>-i<span class="w"> </span><span class="m">0</span>
</code></pre></div>
<p>Donde:</p>
<ul>
<li>
<p><code>-i</code> <n√∫mero workers> le indicar√° a <code>PM2</code> que inicie la aplicaci√≥n en <code>cluster_mode</code> (a diferencia de <code>fork_mode</code>).</p>
<p>Si <n√∫mero workers>se establece a 0, <code>PM2</code> generar√° autom√°ticamente tantos <em>workers</em> como n√∫cleos de CPU haya.</p>
</li>
</ul>
<p>Y as√≠, nuestra aplicaci√≥n se ejecuta en modo de cl√∫ster, sin necesidad de cambios de c√≥digo.</p>
<p>Comprueba que hay 2 procesos de tu aplicaci√≥n funcionando:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>.js
</code></pre></div>
<div class="admonition task">
<p class="admonition-title">Task</p>
<p>Ejecuta las mismas pruebas que antes pero utilizando PM2 y comprueba si se obtienen los mismos resultados.</p>
</div>
<p>Por detr√°s, <code>PM2</code> tambi√©n utiliza el m√≥dulo <code>cluster</code> de Node.js, as√≠ como otras herramientas que facilitan la gesti√≥n de procesos.</p>
<p>En el Terminal, obtendremos una tabla que muestra algunos detalles de los procesos generados:</p>
<p><img alt="" src="../P3_5/pm2_1.png" /></p>
<p>Podemos detener la aplicaci√≥n con el siguiente comando:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>pm2<span class="w"> </span>stop<span class="w"> </span>app.js
</code></pre></div>
<p>La aplicaci√≥n se desconectar√° y la salida por terminal mostrar√° todos los procesos con un estado <code>stopped</code>.</p>
<p><img alt="" src="../P3_5/pm2_2.png" /></p>
<p>En vez de tener pasar siempre las configuraciones cuando ejecuta la aplicaci√≥n con <code>pm2 start app.js -i 0</code>, podr√≠amos facilitarnos la tarea y guardarlas en un archivo de configuraci√≥n separado, llamado <a href="https://pm2.keymetrics.io/docs/usage/application-declaration/">Ecosystem</a>. </p>
<p>Este archivo tambi√©n nos permite establecer configuraciones espec√≠ficas para diferentes aplicaciones.</p>
<p>Crearemos el archivo <em>Ecosystem</em> con el siguiente comando:</p>
<p><img alt="" src="../P3_5/ecosystem.png" /></p>
<p>Que generar√° un archivo llamado <strong><em>ecosystem.config.js</em></strong>. Para el caso concreto de nuestra aplicaci√≥n, necesitamos modificarlo como se muestra a continuaci√≥n:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="err">module.expor</span><span class="kc">ts</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w"> </span><span class="err">apps</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w"> </span><span class="kc">na</span><span class="err">me</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nombre_aplicacion&quot;</span><span class="p">,</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w"> </span><span class="err">scrip</span><span class="kc">t</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;nombre_aplicacion_sin_cluster.js&quot;</span><span class="p">,</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w"> </span><span class="err">i</span><span class="kc">nstan</span><span class="err">ces</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w"> </span><span class="err">exec_mode</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cluster&quot;</span><span class="p">,</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w"> </span><span class="p">},</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w"> </span><span class="p">],</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="p">}</span><span class="err">;</span>
</code></pre></div>
<p>Al configurar <code>exec_mode</code> con el valor <code>cluster</code>, le indica a <code>PM2</code> que balancee la carga entre cada instancia. <code>instances</code> est√° configurado a <strong>0</strong> como antes, lo que generar√° tantos <em>workers</em> como n√∫cleos de CPU.</p>
<p>La opci√≥n <code>-i</code> o <code>instances</code> se puede establecer con los siguientes valores:</p>
<ul>
<li>
<p><code>0</code> o <code>max</code>(en desuso) para "repartir" la aplicaci√≥n entre todas las CPU</p>
</li>
<li>
<p><code>-1</code> para "repartir" la aplicaci√≥n en todas las CPU - 1</p>
</li>
<li>
<p><code>n√∫mero</code> para difundir la aplicaci√≥n a trav√©s de un n√∫mero concreto de CPU</p>
</li>
</ul>
<p>Ahora podemos ejecutar la aplicaci√≥n con:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>pm2<span class="w"> </span>start<span class="w"> </span>ecosystem.config.js
</code></pre></div>
<p>La aplicaci√≥n se ejecutar√° en modo cl√∫ster, exactamente como antes.</p>
<p>Podremos iniciar, reiniciar, recargar, detener y eliminar una aplicaci√≥n con los siguientes comandos, respectivamente:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>$<span class="w"> </span>pm2<span class="w"> </span>start<span class="w"> </span>nombre_aplicacion
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>$<span class="w"> </span>pm2<span class="w"> </span>restart<span class="w"> </span>nombre_aplicacion
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>$<span class="w"> </span>pm2<span class="w"> </span>reload<span class="w"> </span>nombre_aplicacion
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>$<span class="w"> </span>pm2<span class="w"> </span>stop<span class="w"> </span>nombre_aplicacion
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>$<span class="w"> </span>pm2<span class="w"> </span>delete<span class="w"> </span>nombre_aplicacion
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="c1"># Cuando usemos el archivo Ecosystem:</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>$<span class="w"> </span>pm2<span class="w"> </span><span class="o">[</span>start<span class="p">|</span>restart<span class="p">|</span>reload<span class="p">|</span>stop<span class="p">|</span>delete<span class="o">]</span><span class="w"> </span>ecosystem.config.js
</code></pre></div>
<p>El comando <code>restart</code> elimina y reinicia inmediatamente los procesos, mientras que el comando <code>reload</code> logra un tiempo de inactividad de 0 segundos donde los <em>workers</em> se reinician uno por uno, esperando que aparezca un nuevo <em>worker</em> antes de matar al anterior.</p>
<p>Tambi√©n puede verificar el estado, los registros y las m√©tricas de las aplicaciones en ejecuci√≥n.</p>
<div class="admonition task">
<p class="admonition-title">Task</p>
<p>Investiga los siguientes comandos y explica que salida por terminal nos ofrecen y para qu√© se utilizan:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>pm2<span class="w"> </span>ls
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>pm2<span class="w"> </span>logs
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>pm2<span class="w"> </span>monit
</code></pre></div>
</div>
<h2 id="cuestiones">Cuestiones</h2>
<p>Fij√°os en las siguientes im√°genes:</p>
<p><img alt="" src="../P3_5/loadtest_no_cluster_3.png" /></p>
<p><img alt="" src="../P3_5/loadtest_cluster_3.png" /></p>
<p>La primera imagen ilustra los resultados de unas pruebas de carga sobre la aplicaci√≥n sin cl√∫ster y la segunda sobre la aplicaci√≥n clusterizada.</p>
<p>¬øSabr√≠as decir por qu√© en algunos casos concretos, como este, la aplicaci√≥n sin clusterizar tiene mejores resultados?</p>
<h2 id="referencias">Referencias</h2>
<p><a href="https://unixcop.com/how-to-install-expressjs-on-debian-11/">How to install ExpressJS on Debian 11?</a></p>
<p><a href="https://blog.appsignal.com/2021/02/03/improving-node-application-performance-with-clustering.html">Improving Node.js Application Performance With Clustering</a></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Volver al principio
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.top", "toc.integrate", "search.highlight", "content.code.annotate", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>